# SettingsSystem - Сценарии тестирования

## Обзор

Данный документ описывает сценарии для проверки работоспособности системы настроек ProtoSystem.

---

## 1. Базовые сценарии

### 1.1 Первый запуск (без файла настроек)

**Предусловия:** Файл `settings.ini` отсутствует

**Шаги:**
1. Запустить игру
2. Проверить консоль на наличие ошибок
3. Проверить путь к файлу: `Debug.Log(SettingsSystem.Instance.GetSettingsPath())`

**Ожидаемый результат:**
- [ ] Система инициализируется без ошибок
- [ ] Применяются значения по умолчанию из SettingsConfig
- [ ] В консоли: `[SettingsSystem] Settings System initialized successfully`

---

### 1.2 Загрузка существующих настроек

**Предусловия:** Файл `settings.ini` существует с валидными данными

**Шаги:**
1. Запустить игру
2. Проверить значения настроек

**Ожидаемый результат:**
- [ ] Настройки загружены из файла
- [ ] Значения соответствуют содержимому INI файла
- [ ] Событие `Settings.Loaded` опубликовано

---

### 1.3 Сохранение настроек

**Шаги:**
1. Изменить настройку: `settings.Audio.MasterVolume.Value = 0.5f`
2. Вызвать `settings.Save()`
3. Проверить файл `settings.ini`

**Ожидаемый результат:**
- [ ] Файл обновлён
- [ ] Значение `MasterVolume=0.5` присутствует в секции [Audio]
- [ ] Событие `Settings.Saved` опубликовано

---

## 2. Видео настройки

### 2.1 Изменение разрешения

**Шаги:**
1. Получить текущее разрешение
2. Изменить: `settings.Video.Resolution.Value = "1280x720"`
3. Вызвать `settings.Video.Apply()`

**Ожидаемый результат:**
- [ ] Разрешение экрана изменилось
- [ ] В консоли: `[VideoSettings] Resolution set to 1280x720`
- [ ] Событие `Settings.Video.ResolutionChanged` опубликовано

---

### 2.2 Переключение VSync

**Шаги:**
1. Проверить текущее значение `QualitySettings.vSyncCount`
2. Изменить: `settings.Video.VSync.Value = !settings.Video.VSync.Value`
3. Вызвать `settings.Video.Apply()`

**Ожидаемый результат:**
- [ ] `QualitySettings.vSyncCount` изменился
- [ ] Событие `Settings.Video.VSyncChanged` опубликовано

---

### 2.3 Изменение качества графики

**Шаги:**
1. Получить список уровней: `VideoSettings.GetQualityLevels()`
2. Изменить качество: `settings.Video.Quality.Value = 2`
3. Вызвать `settings.Video.Apply()`

**Ожидаемый результат:**
- [ ] `QualitySettings.GetQualityLevel()` возвращает 2
- [ ] Визуальное качество изменилось

---

## 3. Аудио настройки

### 3.1 Изменение громкости

**Шаги:**
1. Подписаться на событие: `EventBus.Subscribe(EventBus.Settings.Audio.MasterChanged, handler)`
2. Изменить: `settings.Audio.MasterVolume.Value = 0.3f`

**Ожидаемый результат:**
- [ ] Обработчик вызван
- [ ] `changed.Value` равен 0.3f
- [ ] `changed.PreviousValue` содержит предыдущее значение

---

### 3.2 Mute

**Шаги:**
1. Установить `settings.Audio.Mute.Value = true`
2. Вызвать `settings.Audio.Apply()`

**Ожидаемый результат:**
- [ ] `AudioListener.volume` равен 0
- [ ] Событие `Settings.Audio.MuteChanged` опубликовано

---

## 4. Управление изменениями

### 4.1 Отслеживание несохранённых изменений

**Шаги:**
1. Проверить: `settings.HasUnsavedChanges()` → false
2. Изменить настройку
3. Проверить: `settings.HasUnsavedChanges()` → true
4. Сохранить
5. Проверить: `settings.HasUnsavedChanges()` → false

**Ожидаемый результат:**
- [ ] Метод корректно отслеживает состояние
- [ ] После Save() возвращает false

---

### 4.2 Откат изменений (Revert)

**Шаги:**
1. Запомнить текущее значение
2. Изменить настройку
3. Вызвать `settings.RevertAll()`
4. Проверить значение

**Ожидаемый результат:**
- [ ] Значение вернулось к сохранённому
- [ ] Событие `Settings.Reverted` опубликовано

---

### 4.3 Сброс к значениям по умолчанию

**Шаги:**
1. Изменить несколько настроек
2. Сохранить
3. Вызвать `settings.ResetAllToDefaults()`
4. Проверить значения

**Ожидаемый результат:**
- [ ] Все значения равны дефолтам из SettingsConfig
- [ ] `HasUnsavedChanges()` возвращает true (т.к. отличается от сохранённого)
- [ ] Событие `Settings.ResetToDefaults` опубликовано

---

## 5. Кастомные секции

### 5.1 Регистрация кастомной секции

**Шаги:**
1. Создать класс `MyGameSettings : CustomSettingsSection`
2. Зарегистрировать: `settings.RegisterSection(new MyGameSettings())`
3. Получить: `var my = settings.GetSection("MyGame")`

**Ожидаемый результат:**
- [ ] Секция зарегистрирована
- [ ] Доступна через `GetSection()`
- [ ] Сохраняется в INI файл

---

### 5.2 Кастомные настройки через конфиг

**Предусловия:** В SettingsConfig добавлена кастомная секция

**Шаги:**
1. Запустить игру
2. Проверить наличие секции в INI файле

**Ожидаемый результат:**
- [ ] Секция создана автоматически
- [ ] Значения по умолчанию применены

---

## 6. Персистентность

### 6.1 INI файл (Desktop)

**Платформа:** Windows/Mac/Linux

**Шаги:**
1. Изменить настройки
2. Сохранить
3. Открыть INI файл в текстовом редакторе
4. Изменить значение вручную
5. Перезапустить игру

**Ожидаемый результат:**
- [ ] Файл читаем в текстовом редакторе
- [ ] Комментарии присутствуют
- [ ] Ручные изменения применены после перезапуска

---

### 6.2 PlayerPrefs (WebGL)

**Платформа:** WebGL билд

**Шаги:**
1. Запустить WebGL билд
2. Изменить настройки
3. Сохранить
4. Обновить страницу

**Ожидаемый результат:**
- [ ] Настройки сохранены в PlayerPrefs
- [ ] После обновления страницы настройки восстановлены

---

## 7. Миграция

### 7.1 Миграция старых настроек

**Предусловия:** INI файл версии 0

**Шаги:**
1. Создать INI файл без строки `; Version:`
2. Запустить игру
3. Проверить версию в обновлённом файле

**Ожидаемый результат:**
- [ ] Миграция выполнена
- [ ] Версия обновлена до текущей
- [ ] Данные сохранены

---

## 8. Граничные случаи

### 8.1 Повреждённый INI файл

**Шаги:**
1. Создать INI файл с невалидным содержимым
2. Запустить игру

**Ожидаемый результат:**
- [ ] Ошибка залогирована
- [ ] Система использует дефолты
- [ ] Игра не крашится

---

### 8.2 Некорректные значения в INI

**Шаги:**
1. В INI файле установить `MasterVolume=abc`
2. Запустить игру

**Ожидаемый результат:**
- [ ] Warning в консоли
- [ ] Используется значение по умолчанию
- [ ] Остальные настройки загружены корректно

---

### 8.3 Отсутствие прав на запись

**Шаги:**
1. Сделать папку настроек read-only
2. Попытаться сохранить

**Ожидаемый результат:**
- [ ] Ошибка залогирована
- [ ] Игра не крашится
- [ ] Пользователь уведомлён (опционально)

---

## 9. Производительность

### 9.1 Частые изменения

**Шаги:**
1. В цикле изменять настройку 1000 раз
2. Измерить время

**Ожидаемый результат:**
- [ ] Нет значительных лагов
- [ ] События публикуются для каждого изменения

---

### 9.2 Большое количество кастомных секций

**Шаги:**
1. Зарегистрировать 20 кастомных секций по 10 настроек
2. Сохранить/загрузить

**Ожидаемый результат:**
- [ ] Операции выполняются за разумное время (<100ms)
- [ ] INI файл корректно структурирован

---

## Чек-лист приёмочного тестирования

### Минимальный набор (Must Have)

- [ ] Первый запуск без ошибок
- [ ] Сохранение/загрузка работает
- [ ] Изменение разрешения применяется
- [ ] События публикуются
- [ ] HasUnsavedChanges() работает корректно
- [ ] RevertAll() откатывает изменения
- [ ] ResetToDefaults() сбрасывает к дефолтам

### Расширенный набор (Should Have)

- [ ] Кастомные секции работают
- [ ] Миграция версий работает
- [ ] PlayerPrefs на WebGL работает
- [ ] Некорректный INI обрабатывается gracefully

### Дополнительно (Nice to Have)

- [ ] Производительность приемлема
- [ ] Комментарии в INI читаемы
- [ ] Все события документированы

---

## Автоматизированные тесты

См. файл `Tests/SettingsSystemTests.cs` для юнит-тестов.
